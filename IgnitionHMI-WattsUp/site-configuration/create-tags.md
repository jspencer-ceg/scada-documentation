#######################
Create Tags and Devices
#######################

This is where the magic happens: where we build out device connections and tag structures for the entire plant. Most recently, this was done for Garnet Mesa.

Getting Started
===============

Important Locations
-------------------
* `SCADA SharePoint <https://consultingengineersgroup.sharepoint.com/sites/PPCTeam/SitePages/ProjectHome.aspx>`_
    * See the ``Document Library > Deployments`` for artifacts from existing site deployments.
* Project folder on the Z: drive. Typically ``Z:\CEG\PROJECTS\Other Projects\<Project Code> <Project Name>``
* `Autodesk Cloud <https://acc.autodesk.com/build/home/projects/39410215-24d5-465e-b294-3bbabd37698f>`_
* `Phil Turmel's Website <https://www.automation-pros.com/>`_
* `Tag and Device Naming Standards <https://consultingengineersgroup.sharepoint.com/:x:/s/PPCTeam/ERofAcoBGs1Kkunj1XI_AQEBq4gogP-jqO5uRicwr1XiRQ?e=sxPCbC>`_
* `Folder Properties for Tag Creation <https://consultingengineersgroup.sharepoint.com/:x:/s/PPCTeam/EYbVYGpU9EVBoGhXM6OpwWIBQRi0-co6XhCvd-c207eAjw?e=Op7NFr>`_
* `CEG IP Schedule <https://consultingengineersgroup.sharepoint.com/:x:/s/SCADA/Ec5O7334e-5GgcamfcSemE4BP8qDNtqju8CtzmdHZmDmmQ?wdOrigin=TEAMS-MAGLEV.p2p_ns.rwc&wdExp=TEAMS-TREATMENT&wdhostclicktime=1750889926167&web=1>`_

First Steps
-----------
#. Create a folder in the SCADA Sharepoint under ``Documents > Deployments``. Save it as the site name.
#. Create a subfolder called ``Artifacts``. This is where we will store any documents provided by third parties. Some examples are the IP schedule for the site and NCU mappings for trackers.
#. Find a project folder that has already been deployed and has working tags for the devices we are working with, e.g. SG3600 inverters and Nextracker trackers. You may need to reference multiple past projects.
#. Copy the relevant Excel spreadsheets into our new folder.

Spreadsheet Import Tool
=======================
Background
----------
This tool is an Ignition project that was developed by Phil Turmel, owner of Automation Professionals, LLC. It allows users to import an Excel spreadsheet of tag definitions to create tags in an Ignition project. It must be included for all of our sites. It will be accessible at ``<site URL>/data/perspective/client/spreadsheet-import-tool``.

Using the Tool
---------------------------
The Spreadsheet Import Tool will be used **after** the Excel workbook is configured for the tag creation. Instructions to create the Excel sheet are listed in the following sections. It will create tags for every sheet in the Excel workbook. Download the .zip file `here <https://inductiveautomation.com/exchange/2660/overview>`_ and view the **Readme.pdf**.

#. Navigate to site gateway and log in as ``cegadmin``.
#. Export existing tags for good measure
    #. Save to backups folder on the SharePoint
#. Import tags
    #. Navigate to the spreadsheet upload tool
    #. Choose the site name as the tag provider
    #. Choose *Leave Existing and Create Missing*
    #. Choose spreadsheet and upload
#. Refresh the MultiXRef cache at ``<site URL>/data/perspective/client/MultiXref``
#. Check that all expected tags are in the Designer.

Creating Tags
=============

Manifest
--------
The manifest tag exists at every site, and is usually created manually.

#. Navigate to ``+ > Data Type Instance > Devices > CEG > Site > Manifest``.
#. Name the tag **Manifest**.
#. Set the value of **SiteLocation** to the geographical location, e.g. *Delta, CO.*
#. Set the value **SiteName** to the name of the site, e.g. *Garnet Mesa Solar*.

PPC
---
This is usually done first. It is created from the site deployment template in the Sharepoint. Update the server name, etc. if necessary and upload using the Spreadsheet Import Tool.

Inverters
---------
Inverters are large devices which convert the DC power generated by solar panels to AC power for use on the grid. We have UDTs for Sungrow SG3600 and SG4400 inverters. Find an Excel workbook used for the same type of inverters from an existing site. PCS is another term for inverter; it means "Power Conversion System."
         
* For Primoris projects
    * View drawing sets in Autodesk cloud
    * ``Project > Sheets > Search and Filter > Find the “Electrical” one > Search until you find info about the inverters.``
        * The site summary will usually be helpful.

#. Create the Excel workbook with information according to the drawings and site information.
#. Use the Spreadsheet Import Tool for the site.

Environmental/MET Station
-------------------------
These are the towers responsible for collecting weather data for the site.

* There are a few main components/towers, each made up of several devices. MET towers are always mapped to inverters.
    * Zenith Met Tower (MS = Met Station)
    * Standalone Albedometer Tower (AS = Albedometer Station)
    * Eclipse Soil Station (SS = Soil Station)
* The RTAC concentrates all the data points from a tower into a data map with a defined structure
    * The map has space for every device, but note that each tower might not have every device
    * Env A, Env B, Env C are the Devices, which are logical maps in Ignition
        * They hold the tags/points for the stations
    * Env01, Env02, etc. represent the towers
* Ignition is expecting the RTAC to have all the data available at specific ports

#. Find the points list provided by the manufacturer (typically Groundwork). This will be located in the ``SCADA`` subfolder of the project on the Z: drive.
#. Create the Excel workbook with information according to the drawings and site information.
#. Use the Spreadsheet Import Tool for the site.

Trackers
--------
Trackers are responsible for positioning the solar panels' angle throughout the day. The main tracker vendors that we work with are Nextracker and Nevados. 

The design, configuration, and terminology of tracker systems varies across vendors. Nextracker trackers are also called Tracker Cores or Network Control Units (NCUs). Each panel is controlled by a motor, also called a self-powered controller (SPC). Several motors are mapped to each NCU. For Nevados, Zone Controllers (ZCs) control rows of motors.

#. Obtain the mapping Excel spreadsheet from the vendor.
    #. For Nextracker, this is the NCU Mapping sheet. For Nevados, it is the RC and ZC datasheets.
#. Find an Excel workbook that we used for this model of tracker. Clear out all the data.
#. Create the workbook by referencing the vendor datasheets, relevant drawings, past deployments, and documentation for the Spreadsheet Upload Tool.
#. Upload the workbook using the Spreadsheet Import Tool.
#. Sanity check: compare final trackers tags in Ignition to the datasheets and drawings. Work with the vendor for connectivity issues after verifying IP addresses of the devices.


Substation
----------
Substation tags are unique and much different from the other tag creation procedures. If CEG builds the substation, the project engineer will put together the points list. If another party builds it, they will provide the points list and we conform it to our standards. 

One example of a point:
* 52H1_86BF_*
    * **52H1** is a breaker
    * **86BF** is something that controls the breaker in some way
    * The drawings will show all the devices connected to the breaker

#. Clone the `watts-up <link>`_ repo and check out the **tm_tags** branch.
#. Create a new folder in *scripts/tag_creation* and name it with the project code ``{PROJ}``.
#. Save the points list(s) as a CSV file in the folder.
    #. Highlight everything, paste values only in a new sheet.
    #. Save as CSV.
#. Copy **substation.py** to the new folder.
#. Make any necessary changes to accomodate the formatting of the sheet. Reference past deployments & current production tags for help.
    #. You can add a ``breakpoint()`` before the ``create_substation()`` function to check the values of variables.
#. Edit the paths in **main.py** and run from the root of the repo.
#. Review the generated ``substation-<timestamp>.json`` and check the tags against the points list.
#. Export all current tags (Designer > Project Browser > Tag Browser > Highlight all tags > Click ... > Export Tags)
#. Import the tags generated by the script.
#. Sanity check
    #. Check tag quality and note any tags with errors.
        * It might be expected that some BinaryOutput points are not reporting their status.
    #. Observe all the same tag names from the points list
        * Clock icon indicates history for the tag.
        * Bell icon means there is an alarm configured for the tag.
    #. Check tag values
        * If the tag is supposed to be a float but it is showing as an integer, It might need some more config in the RTAC.
    #. Check the substation oneline diagram to see the points.


.. todo::
    When it comes up, document the process for creating tags for devices we have not worked with yet.

Tag and Device Naming Standards
===============================
* Find spreadsheet in SCADA SharePoint
* Name device & device hostname from the IP schedule
* Dashes only in hostnames
* Create tag name from the drawings

Inverters Example
-----------------
* Device name (from Description column in IP schedule): INV-S01
    * Format to PascalCase and remove hyphens: InvS01
        * We use their numbering, including like INV-1A01
        * We will always call inverter devices **InvXXX**
* Device hostname (from hostname column in IP schedule): inv-s01.ceg.localsite
    * But actually, we don’t communicate with these directly, the RTAC uses them, so we are SCRAPPING these
    * These devices do not get hostnames, they reference ports on the RTAC (20101, 20102, etc.)
* Tag name: PCS-01

Trackers Example
----------------
* Tracker core is the device & the folder
    * Device name & folder name: Trk01, regardless of any extra numbering schemes
* SPC/Motor is called MotorXXXX
* Device hostname (from hostname column in IP schedule): trk-01.ceg.localsite

PPC
---
* We will always call the PPC **PPC#**

Environmental
-------------
* We will always call devices **EnvA**, **EnvB**, **EnvC**, etc.
* These devices do not get hostnames, they reference ports on the RTAC (20201, 20202, etc.)

Substation RTU
--------------
* We will always call the substation RTU **RTU#**

Examples
========

Garnet Mesa Trackers
--------------------
**About the spreadsheet**

Find the spreadsheet with NCU groupings, which looks like this:

.. image:: ../img/ncu-mapping-example.png

* BLK# = BlockNum = Inverter.
* SPCStart and SPCStop are motor IDs to denote ranges.
* There is a formula used to calculate the TrackerIndexStart, which is used for logical addressing of the SPCs.
* The TrackerIndexStart can be the same value on different NCUs.
* The RegOffsetEval is used to populate the hrs_ofs_ncu SPC parameter.

#. Obtain the NCU mapping Excel spreadsheet from the vendor.
#. Find an Excel workbook that we used for this model of tracker. Clear out all the data pertaining to SPC and NCU numbering.
#. Fill out the **TrackerMotors** and **TrackerCores** Excel sheets.
    #. Copy the **SPCstart** and **SPCStop** columns exactly.
    #. Apply the formula ``SPCStop - SPCStart + 1`` to populate the **TrackerNum** column. Compare this to the NCU mapping sheet.
#. Copy the **NCUNum** and **BlockNum** columns as values only.
    #. For cells that were merged (span multiple rows), make sure you manually fill these out. Double-check for accuracy!
#. Use the ``CONCAT()`` function with **SPCStart** and **SPCStop** to populate the **SPCNumIterator** column.
#. Populate the **TrackerIndexStart** column.
    #. The first row gets a **TrackerIndexStart** of 1
    #. Then, a formula should be applied like this:
        #. If the current **NCUNum** equals the previous **NCUNum**, then set ``TrackerIndexStart = <previous TrackerIndexStart> + <previous TrackerNum>``. Otherwise, set it to 1.

.. note:: 
    The Spreadsheet Import Tool has trouble reading cells using the ``CONCAT()`` function. After it has produced the correct data, you should copy the data as values only and overwrite everything in the **SPCNumIterator** column.


Troubleshooting
===============
* Update the spreadsheet. Be sure to version the new copy similar to points lists.
* Nuke the relevant tag structure, the entire site, or one bad hierarchy e.g. ``Trackers``.
* Re-run the import.
* Double-check IP addresses with any relevant parties.
